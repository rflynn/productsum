<!html>
<html>
    <head>
        <title></title>
        <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/mathjs/2.5.0/math.min.js"></script>
        <script src="http://omnipotent.net/jquery.sparkline/2.1.2/jquery.sparkline.min.js"></script>
        <style type="text/css">
            body {
                font-family: GillSans,"Gill Sans MT",Calibri,sans-serif;
                font-size: 14px;
                font-weight:100;
            }
            form {
                margin: 0px;
                margin-bottom: 3px;
                padding: 0;
            }
            input {
                font-size: x-large;
            }
            div.box {
                width: 220px;
                height: 380px;
                float: left;
                display: inline-block;
                border: 1px solid #eee;
                border-radius: 0px;
                margin: 0 -1px -1px 0;
                padding: 5px;
                background-color: #fff;
                text-align: center;
            }
            div.match {
                border: 1px solid green;
                /*border-bottom: 1px solid green;
                border-right: 1px solid green;*/
            }
            div.img {
                width: 200px;
                height: 200px;
                margin: auto;
                margin-bottom: 10px;
                background-size: cover /*contain*/;
                background-position: center;
                background-repeat: no-repeat;
            }
            div.price sup {
                font-size: x-small;
            }
            #sparkline {
                margin-top: 0.5em;
                margin-bottom: 0.5em;
            }
            ol {
                margin-top: 0;
            }
            #spinner {
                position: absolute;
                left: 35%;
                top: 25%;
                margin:0px auto;
                height: 250px;
                width: 250px;
                -webkit-animation: rotation .6s infinite linear;
                -moz-animation: rotation .6s infinite linear;
                -o-animation: rotation .6s infinite linear;
                animation: rotation .6s infinite linear;
                /*background-color: #fff;*/

                /*
                border-left:50px solid rgba(0,174,239,.15);
                border-right:50px solid rgba(0,174,239,.15);
                border-bottom:50px solid rgba(0,174,239,.15);
                border-top:50px solid rgba(0,174,239,.8);
                */
                border-left:10px solid rgba(0,0,0,.3);
                border-right:10px solid rgba(0,0,0,.3);
                border-bottom:10px solid rgba(0,0,0,.3);
                border-top:10px solid rgba(0,0,0,.9);

                border-radius:100%;
                z-index: 99999;
                display: none; /* hide initially */
            }
            @-webkit-keyframes rotation {
                from {-webkit-transform: rotate(0deg);}
                to {-webkit-transform: rotate(359deg);}
            }
            @-moz-keyframes rotation {
                from {-moz-transform: rotate(0deg);}
                to {-moz-transform: rotate(359deg);}
            }
            @-o-keyframes rotation {
                from {-o-transform: rotate(0deg);}
                to {-o-transform: rotate(359deg);}
            }
            @keyframes rotation {
                from {transform: rotate(0deg);}
                to {transform: rotate(359deg);}
            }
            #clear {
                font-size: large;
                cursor: pointer;
                margin: 0.5em;
            }
            a.search-by-me {
                cursor: pointer;
            }
            xmp {
                max-width: 100%;
                overflow: scroll;
            }
            #totalproducts {
                display: inline-block;
            }
            #merchant-slugs div {
                display: inline-block;
                background-color: #F5D0A9;
                border-radius: 3px;
                padding: 0 3px 0 3px;
                margin: 1px 2px 1px 0;
            }
            #brand-slugs span {
                display: inline-flex;
                background-color: #E0F2F7;
                border-radius: 3px;
                padding: 0 3px 0 3px;
                margin: 1px 2px 1px 0;
            }
            #brand-slugs div a:link, a:visited {
                color: black;
                text-decoration: none;
            }
            #parse-qstr div {
                display: inline-block;
                margin-right: 2px;
                padding: 2px;
                border-radius: 2px;
            }
            #parse-qstr .brand {
                background-color: LightBlue;
            }
            #parse-qstr .product {
                background-color: LightSkyBlue;
            }
            #parse-qstr .material {
                background-color: LightCoral;
            }
            #parse-qstr .color {
                background-color: PaleGoldenRod;
            }
            #parse-qstr .pattern {
                background-color: DarkGoldenRod;
            }
            #parse-qstr .quantity {
                background-color: purple;
            }
            #parse-qstr .size {
                background-color: pink;
            }
            #parse-qstr .ngram2 {
                background-color: #ccc;
            }
            #parse-qstr .price {
                background-color: LightGreen;
            }
            #parse-qstr .null {
                border: 1px dotted #ccc;
            }
        </style>
    </head>

    <body>

        <div id="spinner"></div>

        <div id="url" style="clear:both">{{ url }}</div>

        <div style="white-space: nowrap">
            <form method="get" action=".">
                <span id="clear">&#x2573;</span>
                <input id="q" name="q" size="90" value="{{ q }}">
            </form>
        </div>

        <div style="margin-left: 2.9em">
            <div id="parse-qstr"></div>
            <div id="sparkline"></div>
            <div id="metadata">
                <div id="totalhits"></div>
                <div id="totalproducts"></div>
            </div>
            <div id="results"></div>
        </div>

        <br style="clear:both">

        <div id="notes">

        <div style="width:100%; margin:0; padding:0">

        <div style="width: 50%; display: inline-block">

        <label for="goodlist">Example Product Searches</label>
        <ol id="goodlist">
            <li><a href="/?q=Christian Louboutin So Kate Patent 120mm Red Sole Pump, Shocking Pink $675">Christian Louboutin So Kate Patent 120mm Red Sole Pump, Shocking Pink $675</a>
            <li><a href="/?q=Clarisonic Cashmere Cleanse Facial Brush Head $30">Clarisonic Cashmere Cleanse Facial Brush Head $30</a>
            <li><a href="/?q=Ultimate Sun Protection Cream SPF 50+ WetForce, 1.7 oz. $36">Ultimate Sun Protection Cream SPF 50+ WetForce, 1.7 oz. $36</a>
            <li><a href="/?q=SHISEIDO Urban Environment UV Protection Cream SPF 40 $32">SHISEIDO Urban Environment UV Protection Cream SPF 40 $32</a>
            <li><a href="/?q=Kiehl's Since 1851 Facial Fuel UV Guard SPF 50/1.7 oz. $38">Kiehl's Since 1851 Facial Fuel UV Guard SPF 50/1.7 oz. $38</a>
            <li><a href="/?q=Deborah Lippmann Nail Lacquer in Respect $18">Deborah Lippmann Nail Lacquer in Respect $18</a>
            <li><a href="/?q=Burberry 'My Burberry' Eau de Parfum $95">Burberry 'My Burberry' Eau de Parfum $95</a>
            <li><a href="/?q=Glam-To-Go Cheek, Eye %26 Lip Travel Case">Glam-To-Go Cheek, Eye & Lip Travel Case</a> &mdash; test ampersand handling
            <li><a href="/?q=Powder Blush Case %26 Brush $40">Powder Blush Case & Brush $40</a> &mdash; test ampersand handling
            <li><a href="/?q=Limited Edition In the Nude Compact for Eyes">Limited Edition In the Nude Compact for Eyes</a>
            <li><a href="/?q=CLINIQUE Sonic System Acne Solutions Deep Cleansing Brush Head $26">CLINIQUE Sonic System Acne Solutions Deep Cleansing Brush Head $26</a>
            <li><a href="/?q=CLINIQUE Skinny Meets Chubby Set- 45.00 Value $27.50">CLINIQUE Skinny Meets Chubby Set- 45.00 Value $27.50</a>
            <li><a href="/?q=For Men Sonic System Deep Cleansing Brush $89.5">For Men Sonic System Deep Cleansing Brush $89.5</a>
            <li><a href="/?q=NVPS Leopard-Print Red Sole Pump, Brown $1045">NVPS Leopard-Print Red Sole Pump, Brown $1045</a>
            <li><a href="/?q=Christian Louboutin Rivierina Patent Red Sole Pump, Shocking Pink $745">Christian Louboutin Rivierina Patent Red Sole Pump, Shocking Pink $745</a>
            <li><a href="/?q=Sisley Paris Botanical D-Tox, 30ml $245">Sisley Paris Botanical D-Tox, 30ml $245</a>
            <li><a href="/?q=Sisley Paris Eye Contour Mask, 30ml">Sisley Paris Eye Contour Mask, 30ml</a>
            <li><a href="/?q=Clarins UV Plus SPF 50, 1.7 oz. $42">Clarins UV Plus SPF 50, 1.7 oz. $42</a>
            <li><a href="/?q=TOM FORD Patent Leather Pin-Heel Pump, Nude $890">TOM FORD Patent Leather Pin-Heel Pump, Nude $890</a> &mdash; there are several similar entries which should NOT match
            <li><a href="/?q=CLINIQUE Sun SPF 50 Face Cream/1.7 oz. $21.50">CLINIQUE Sun SPF 50 Face Cream/1.7 oz. $21.50</a>
            <li><a href="/?q=Christian Louboutin Cataclou Studded Red Sole Demi-Wedge Sandal, Black/Dark Gunmetal $795">Christian Louboutin Cataclou Studded Red Sole Demi-Wedge Sandal, Black/Dark Gunmetal $795</a> &mdash; phrases "red sole" and "demi-wedge" are missing, and spoil match... also, image recognition could help tell the difference between 2 identical text definitions from bergdorf...
            <li><a href="/?q=Chloé Drew Mini leather shoulder bag €1190">Chloé Drew Mini leather shoulder bag €1190</a>
            <li><a href="/?q=RVCA Stratta Dress">RVCA Stratta Dress</a>
            <li><a href="/?q=Nike Roshe One sneakers €90">Nike Roshe One sneakers €90</a>
            <li><a href="/?q=KATE SPADE NEW YORK Dorothy Bucket Hat $118">KATE SPADE NEW YORK Dorothy Bucket Hat $118</a> &mdash; NOTE: very different images for matching products
            <li><a href="/?q=Clinique Blush Brush $29.5">Clinique Blush Brush $29.5</a> -- Clinique brand mixed into name for 1, but not the other...
            <li><a href="/?q=RALPH LAUREN Leather Large Hobo Bag $448">RALPH LAUREN Leather Large Hobo Bag $448</a>
            <li><a href="/?q=Alexander McQueen Leopard-Print Pony Hair Envelope Clutch Bag $1015">Alexander McQueen Leopard-Print Pony Hair Envelope Clutch Bag $1015</a>
            <li><a href="/?q=Life is good Go-To Hoodie $48">Life is good Go-To Hoodie $48</a>
            <li><a href="/?q=Christian Louboutin Follies Spikes Pumps $1295">Christian Louboutin Follies Spikes Pumps $1295</a> &mdash; sufficiently different product names, prices, photos, you name it...
            <li><a href="/?q=Menscience Eye Gel Mask $16">Menscience Eye Gel Mask $16</a> same product, different images
        </ol>

        <label for="goodlist">Example URL &rarr; Product &rarr; Product Search</label>
        <ol id="goodlist">
            <li><a href="/?q=http://www.harpersbazaar.com/beauty/g5029/todays-beauty-secret/?slide=1">http://www.harpersbazaar.com/beauty/g5029/todays-beauty-secret/?slide=1</a>
            <li><a href="/?q=http://www.elle.com/fashion/news/g27407/flat-party-shoes-for-the-holidays/?slide=1">http://www.elle.com/fashion/news/g27407/flat-party-shoes-for-the-holidays/?slide=1</a>
            <li><a href="/?q=http://www.cnet.com/products/belkin-qode-ultimate-pro-keyboard-case-for-ipad-air-2/">http://www.cnet.com/products/belkin-qode-ultimate-pro-keyboard-case-for-ipad-air-2/</a>
            <li><a href="/?q=http://nymag.com/thecut/2015/12/mens-holiday-gift-guide/slideshow/">http://nymag.com/thecut/2015/12/mens-holiday-gift-guide/slideshow/</a>
            <li><a href="/?q=http://www.polyvore.com/roland_mouret_saxby_cutout_jumpsuit/thing?id=155948865">http://www.polyvore.com/roland_mouret_saxby_cutout_jumpsuit/thing?id=155948865</a>
        </ol>

        </div>

        <div style="width: 50%; float:right">
        <label for="badlist">FIXME</label>
        <ol id="badlist">

            <li>brand
                <ol>
                    <li><a href="/?q=Clé de Peau Beauté Brightening Mask">Clé de Peau Beauté Brightening Mask</a> vs. non-brand <a href="/?q=Brightening Mask $30">Brightening Mask $30</a>
                    <li><a href="/?q=KATE SPADE NEW YORK Sailor's Knot Stud Earrings, Silver $48">KATE SPADE NEW YORK Sailor's Knot Stud Earrings, Silver $48</a> &mdash; ES produces significantly different scores for products with exactly the same brand, name and price...
                    <li><strike><a href="/?q=Clé de Peau Beauté Intensifying Cream Eyeliner $60">Clé de Peau Beauté Intensifying Cream Eyeliner $60</a> &mdash; different brand_orig values, we need to fix elasticsearch queries to handle original brand and normalized brand...</strike>
                    <li><strike><a href="/?q=TIBI Blouse">TIBI Blouse</a> &mdash; TODO: extract brand algorithmically</strike>
                    <li><strike><a href="/?q=Lucky Brand Women's Nightt Booties $129">Lucky Brand Women's Nightt Booties $129</a> &mdash; Macy's brands missing</strike>
                    <li><strike>compare <a href="/?q=Lancome">Lancome</a> to <a href="/?q=Lancôme">Lancôme</a></strike>
                    <li><strike><a href="/?q=RED Valentino Elastic Waist Pants $350">RED Valentino Elastic Waist Pants $350</a> red valentino brand doesn't match?! wtf...</strike>
                </ol>

            <li>non-commutative results: searching by product A &rarr; [B] &ne; B &rarr; [A]
                <ol>
                    <li><a href="/?q=Clé de Peau Beauté Limited Edition Makeup Coffret $210">Clé de Peau Beauté Limited Edition Makeup Coffret $210</a> &mdash; product name only shares one word?!
                    <li><a href="/?q=Super Fluid UV Defense Ultra Light Sunscreen SPF 50 , 1.7 oz. $38">Super Fluid UV Defense Ultra Light Sunscreen SPF 50 , 1.7 oz. $38</a> yields 3 matches, including "Kiehl's Since 1851 Super Fluid UV Defense Ultra Light Sunscreen SPF 50+, 1.7 oz. $38", but <a href="/?q=Kiehl's Since 1851 Super Fluid UV Defense Ultra Light Sunscreen SPF 50+, 1.7 oz. $38">Kiehl's Since 1851 Super Fluid UV Defense Ultra Light Sunscreen SPF 50+, 1.7 oz. $38</a> yields 2, not containing the first
                    <li><a href="?q=DIOR Hypnotic Poison  $77">DIOR Hypnotic Poison  $77</a> vs. <a href="/?q=DIOR Hypnotic Poison 1.7 oz Eau De Toilette Spray $77">DIOR Hypnotic Poison 1.7 oz Eau De Toilette Spray $77</a>
                </ol>

            <li>unit conversions
                <ol>
                    <li>&euro; &hArr; $ conversion <a href="/?q=Nike Roshe One sneakers €90">Nike Roshe One sneakers €90</a>
                    <li>ml &hArr; oz conversion
                        <ol>
                            <li>30ml vs. 1.16 oz <a href="/?q=Sisley Paris Eye Contour Mask, 30ml">Sisley Paris Eye Contour Mask, 30ml</a>
                            <li>50ml vs 1.6 oz <a href="/?q=Burberry Eau de Parfum - My Burberry, 50ml $95">Burberry Eau de Parfum - My Burberry, 50ml $95</a>
                            <li>"2.1 oz" vs. "60 ml" <a href="/?q=Sisley Paris Black Rose Mask 2.1 oz $162">Sisley Paris Black Rose Mask 2.1 oz $162</a>
                        </ol>
                    <li>TODO: "1 piece" should match anything not stating another amount; but the textual difference when not stated reduces the match score: <a href="/?q=Foreo ISSA Brush Head - Cobalt Blue (1 piece) $24.90">Foreo ISSA Brush Head - Cobalt Blue (1 piece) $24.90</a> vs. <a href="/?q=Foreo ISSA Brush Head - Cobalt Blue $24.90">Foreo ISSA Brush Head - Cobalt Blue $24.90</a>
                    <li><strike>are not respected -- e.g. "1.7 fl oz" vs. 3.4 fl oz"</strike>
                </ol>

            <li>price
                <ol>
                    <li>price difference: compare <a href="/?q=Charlotte Olympia Orbital Pomeline Suede Pump, Black $843">Charlotte Olympia Orbital Pomeline Suede Pump, Black $843</a> vs. <a href="/?q=Charlotte Olympia Orbital Pomeline Suede Pump, Black">Charlotte Olympia Orbital Pomeline Suede Pump, Black</a>
                    <li><strike>price n/a <a href="/?q=Chloe Black Leather Mini Georgia Bag $1090">Chloe Black Leather Mini Georgia Bag $1090</a></strike>
                </ol>
            <li>non-normalized language
                <ol>
                    <li><a href="/?q=Cushnie et Ochs Sequin Samantha Dress $1795">Cushnie et Ochs Sequin Samantha Dress $1795</a> fwrd "sequin samantha dress" vs. shopbop "sequin strapless dress" ... the 2nd shopbop img is very close to first fwrd image...
                    <li><strike><a href="/?q=Deborah Lippmann Nail Lacquer in Whip It $18">Deborah Lippmann Nail Lacquer in Whip It $18</a> &mdash; synonym (nail polish vs. nail lacquer)</strike>
                </ol>
            <li>matching/grouping doesn't respect brand
                <ol>
                    <li><a href="/?q=Leather Kitten Heel Pumps">Leather Kitten Heel Pumps</a> &mdash; too broad
                </ol>
            <li>specificity: even brand + name + price can just be too vague...
                <ol>
                    <li><a href="/?q=Ray-Ban Sunglasses $200">Ray-Ban Sunglasses $200</a>
                    <li><a href="/?q=KATE SPADE NEW YORK Tiny Metro Watch $175">KATE SPADE NEW YORK Tiny Metro Watch $175</a>
                    <li><a href="/?q=SERGIO ROSSI Suede Pumps $605">SERGIO ROSSI Suede Pumps $605</a>
                    <li><a href="/?q=Stuart Weitzman Nudist song Sandals $415">Stuart Weitzman Nudist song Sandals $415</a>
                </ol>
            <li>color
                <ol>
                    <li>TODO: explicit color vs. unstated <a href="/?q=KATE SPADE NEW YORK Sailor's Knot Stud Earrings, Silver $48">KATE SPADE NEW YORK Sailor's Knot Stud Earrings, Silver $48</a> vs. <a href="/?q=KATE SPADE NEW YORK Sailor's Knot Stud Earrings, $48">KATE SPADE NEW YORK Sailor's Knot Stud Earrings, $48</a>
                    <li><strike><a href="/?q=Michael Stars Long Sleeve Turtleneck in Pinot $88">Michael Stars Long Sleeve Turtleneck in Pinot $88</a> colors "Pinot" vs. "Quicksand"</strike>
                    <li><strike><a href="/?q=miharayasuhiro/white-calf-hair-sneakers">miharayasuhiro/white-calf-hair-sneakers</a> match on 3/4 words ignores most important -- color (photos are drastically different)</strike>
                </ol>
            <li>product dupes
                <ol>
                    <li><a href="/?q=Clé de Peau Beauté Limited Edition Nail Lacquer Trio">Clé de Peau Beauté Limited Edition Nail Lacquer Trio</a>
                    <li><a href="/?q=Same Swim Babe Bandeau Bikini Top">Same Swim Babe Bandeau Bikini Top</a>
                </ol>
            <li>many legitimate matches
                <ol>
                    <li><a href="/?q=3.1 Phillip Lim 'Pashli Mini' Leather Satchel $695">3.1 Phillip Lim 'Pashli Mini' Leather Satchel $695</a> -- dozens of legit matches, algorithm doesn't handle it well
                </ol>
            <li>other product attributes
                <ol>
                    <li><a href="/?q=DIOR Hypnotic Poison 1.7 oz Eau De Toilette Spray $77">DIOR Hypnotic Poison 1.7 oz Eau De Toilette Spray $77</a> &mdash; product should match but doesn't: '<a href="/?q=DIOR Hypnotic Poison Eau Secrete by Christian Dior for Women $78">DIOR Hypnotic Poison Eau Secrete by Christian Dior for Women $78</a>
                    <li><strike>TODO: synonym between lotion/sunscreen <a href="Elizabeth Arden Ceramide Lift and Firm Day Cream Broad Spectrum Sunscreen SPF 30 (1.7 oz.) $74">Elizabeth Arden Ceramide Lift and Firm Day Cream Broad Spectrum Sunscreen SPF 30 (1.7 oz.) $74</a></strike>
                </ol>
            <li>tokenizing
                <ol>
                    <li><strike>"SPF 34" vs. "SPF34" <a href="/?q=SHISEIDO Sun Protection Eye Cream SPF34, 15ml $35.50">SHISEIDO Sun Protection Eye Cream SPF34, 15ml $35.50</a></strike>
                    <li><strike>TODO: normalize "1.7oz" to "1.7 oz" in ES (e.g. <a href="/?q=UV Plus SPF 50, 1.7 oz. $42">UV Plus SPF 50, 1.7 oz. $42</a>)</strike>
                </ol>
        </ol>
        </div>

            <div>
                <div id="merchant-slugs"></div>
                <div id="brand-slugs"></div>
            </div>

        </div>
        </div>

        <br style="clear:both">

        <xmp></xmp>

    </body>

    <script>

function is_url(str)
{
    var s = str.trim();
    return s.startsWith('http://') || s.startsWith('https://');
}

SCORE_MIN_THRESHOLD = 1.0

function match_threshold(scores)
{
    var threshold = 0;
    if (scores.length) {
        var scores = scores.slice(0, 25);
        while (scores.length < 10)
            scores.push(0);
        threshold = Math.max(SCORE_MIN_THRESHOLD,
                            math.mean(scores) + (math.std(scores)));
        if (threshold >= scores[0])
            threshold = math.mean(scores);
    }
    return threshold;
}

function analyze(scores)
{
    var scores = scores.slice(0, 25);
    var h2 = {};
    if (scores.length) {
        console.log('mean:', math.mean(scores));
        console.log('median:', math.median(scores));
        console.log('mode:', math.mode(scores));
        console.log('std:', math.std(scores));
        console.log('var:', math.var(scores));
        console.log('max:', math.max(scores));
        var threshold = match_threshold(scores);
        console.log('threshold', threshold);
        var k1 = '' + threshold.toFixed(2) + ':100';
        var k2 = '0:' + threshold.toFixed(2);
        h2[k1] = 'green';
        h2[k2] = '#ccc';
    }
    return $.range_map(h2);
}

function do_sparkline(scores)
{
    var rangeMap = analyze(scores);
    $('#sparkline').sparkline(scores,
        {
            type: 'bar',
            colorMap: rangeMap,
            chartRangeMin: 0
        });
}

function display_price(p)
{
    var c = p.currency == 'EUR' ? '&euro;' : '$';
    var d = p.price_min;
    if (d == Number(d).toFixed(0))
        d = Number(d).toFixed(0);
    else
        d = Number(d).toFixed(2);
    if (!p.in_stock)
        return $('<div>').text('out-of-stock');
    return $('<div>').append($('<sup>').html(c)).append(d);
}

function display_data(query, data)
{
    $('xmp').text(JSON.stringify(data.hits, null, 4))

    $('#totalhits').text('' + data.hits.total + ' hits');

    var scores = data.hits.hits.map(function(hit){ return hit._score; });

    var score_threshold = 0;
    if (scores) {
        do_sparkline(scores);
        score_threshold = match_threshold(scores);
    }

    $('#results').hide();
    $('#results').empty();
    $('#results').show();

    $.each(data.hits.hits, function(i, item) {

        var p = item._source;
        var a = $('<a>');
        a.attr('href', p.url);
        a.attr('target', '_blank');

        var searchbyme = $('<a class="search-by-me" href="#">');

        var imgurl = p.img_urls ? p.img_urls[0] : '';

        var divimg = $('<div class="img" style="background-image:url(' + imgurl + ')">');
        if (p.img_urls) {
            p.img_urls.forEach(function(x){ divimg.attr('data-img', x); });
        }

        $(divimg).mouseover(function(){
            var imgs = p.img_urls || [];
            if (imgs.length > 1) {
                $(divimg).css('background-image', 'url(' + imgs[1] + ')');
            }
        });

        $(divimg).mouseout(function(){
            var imgs = p.img_urls || [];
            if (imgs.length > 0) {
                $(divimg).css('background-image', 'url(' + imgs[0] + ')');
            }
        });

        var boxdiv = $('<div class="box">').append(
            $('<div class="score">').text('score ' + Number(item._score).toFixed(3)),
            searchbyme.html('search by product &#128269;'),
            divimg,
            $('<div class="brand">').text(p.brand || ''),
            $('<div class="name">').append(a.text(p.name || '')),
            //$('<div class="price">').text(p.price_min || (p.in_stock ? '' : 'out of stock')),
            $('<div class="price">').append(display_price(p)),
            $('<div class="host">').text(p.url_host)
        );
        if (item._score >= score_threshold)
            boxdiv.addClass('match');
        boxdiv.css('z-index', (10000-i).toString());
        boxdiv.appendTo('#results');
    });
    $('div.box').draggable({
        start: function(event, ui) {
            $(this).css('z-index', 9999);
        },
        revert: function(event, ui) {
            // ref: http://stackoverflow.com/questions/5735270/revert-a-jquery-draggable-object-back-to-its-original-container-on-out-event-of
            $(this).data("uiDraggable").originalPosition = {
                top : 0,
                left : 0
            };
            $(this).css('z-index', 1);
            return !event;
        }
    });

    $('a.search-by-me').click(function(event) {
        do_search_by_product($(this).closest('div.box'));
        event.preventDefault();
    });

    $('#results').show();
}

function es_cape(str) {
    return str.replace(/[/]/gi, function(c){ return "\\"+c; });
}

function es_index()
{
    return 'http://search-es0-qjusld7s4jpxxcsy2ktlkfr42m.us-east-1.es.amazonaws.com/product/';
}

function text_query(str)
{
    var should = [
        {
            'multi_match' : {
                'query': str,
                'fields': [ 'name', 'brand', 'price']
            }
        }
    ];
    var m = str.match(/[$€£¥]\s?(\d+(?:\.\d+)?)/);
    if (m) {
        var price = Number(m[1]); // ["$40", "40"]
        should.push({
            'range': {
                'price_min':{
                    'gt': price - 2,
                    'lt': price + 2,
                    'boost': 2.0
                }
            }
        });
    }
    return {
        'bool': {
            'should': should
        }
    };
}

function url_query(str)
{
    return {
        'bool':{
            'must':[
                {'match':{'url':str}}
            ]
        }
    };
}

function structured_query(params)
{
    var should = [];
    var must = [];
    if (params.brand) must.push(
        {
            match: {
                'brand': params.brand
            }
        }
    )
    if (params.name) must.push({'match':{'name': params.name}})
    if (params.price) {
        must.push({
            'range': {
                'price_min':{
                    'gt': params.price - 2,
                    'lt': params.price + 2,
                    'boost': 2.0
                }
            }
        });
    }
    return {
        'bool':{
            'should': should,
            'must': must
        }
    };
}

function parse_qstr(qstr)
{
    $('#parse-qstr').empty();
    $.getJSON(
        '/parse?q=' + (qstr || ''),
        function(data) {
            var must = [];
            var should = [];
            var or = [];
            console.log(data.result.q);
            var qstrlow = qstr.toLowerCase();
            var qi = 0;
            var seen_brand = false;
            for (var i = 0; i < data.result.q.length; i++)
            {
                var item = data.result.q[i];
                var type_ = item[0];
                var toks = item[1];
                var qi2s = qstrlow.indexOf(toks[0], qi);
                var qi2e = qstrlow.indexOf(toks[toks.length-1], qi2s) + toks[toks.length-1].length;
                var substr = qstr.substr(qi2s, qi2e - qi2s);
                /*
                if (toks.join(' ').length > substr.length && toks.length <= 2) {
                    // e.g. "1.7oz" is parsed more accurately to ["1.7","oz"]; use parsed version...
                    // NOTE: breaks down with fucking apostrophoes...
                    substr = toks.join(' ');
                }*/
                qi = qi2e;
                $('#parse-qstr').append($('<div class="'+type_+'">').text(substr));
                if (type_ === 'brand' && !seen_brand) {
                    //must.push({match_phrase:{brand: substr}})
                    must.push({
                        bool: {
                            should:[
                                {match_phrase:{brand: substr}},
                                {match_phrase:{brand_orig: substr}},
                                {match_phrase:{brand_raw: substr}},
                                {match_phrase:{brand_ascii: substr}},
                                {match_phrase:{brand_orig_ascii: substr}}
                                //{missing:{field: 'brand'}}
                            ],
                            minimum_should_match: 1
                        }});
                } else if (type_ === 'price') {
                    var p = Number(toks[0].substr(1));
                    must.push({
                        'range': {
                            'price_min':{
                                'gt': p * 0.9,
                                'lt': p * 1.1
                            }
                        }
                    });
                } else if (type_ == 'product') {
                    must.push({match_phrase:{name: substr}});
                } else if (type_ == 'color') {
                    should.push({
                        bool: {
                            should:[
                                {match_phrase:{color: substr}},
                                {match_phrase:{available_colors: substr}},
                                {match_phrase:{name: substr}}
                            ]
                        }});
                } else {
                    should.push({match_phrase:{name:substr}});
                }
                seen_brand = seen_brand || type_ === 'brand';
            }
            console.log('match', must, should);
            search(undefined, undefined,
                {
                    query: {must: must, should: should}
                    //filter: {or: []}
                });
        }
    );
}

function search(txtq, params, phrases_yall)
{
    // curl -X POST 'search-es0-qjusld7s4jpxxcsy2ktlkfr42m.us-east-1.es.amazonaws.com/product/_search' -d '{"query":{"bool":{"must":[{"match":{"brand":"VALENTINO GARAVANI"}},{"match":{"name":"pump"}}]}}}' | python -mjson.tool | less
    start_loading();

    var query = {};
    if (phrases_yall) {
        query = {
            query: {
                filtered : {
                    query: {
                        bool: phrases_yall.query
                    },
                    filter: phrases_yall.filter
                }
            }
        };
    } else if (params) {
        query = {
            query: {
                filtered : {
                    query: structured_query(params),
                }
            }
        };
    } else if (is_url(txtq)) {
        query = {
            query: url_query(es_cape(txtq))
        };
    } else {
        query = {
            query: text_query(es_cape(txtq))
        };
    }
    query.from = 0;
    query.size = 100;

    $.ajax({
        method: 'POST',
        url: es_index() + '_search',
        crossDomain: true,
        timeout: 5000,
        dataType: 'json',
        data: JSON.stringify(query)
    }).done(function(data) {
        display_data(txtq, data);
        stop_loading();
    }).error(function(err) {
        stop_loading();
        alert('fuck...');
    });
}

function do_search(txtq, params)
{
    var otxtq = txtq;
    var m = txtq.match(/brand:\(([^)]*)\)/);
    if (m) {
        params = params || {};
        params.brand = m[1];
        txtq = txtq.replace(m[0], '');
        m = txtq.match(/[$€£¥]\s?(\d+(?:\.\d+)?)/)
        if (m) {
            params.price = Number(m[1]);
            txtq = txtq.replace(m[0], '');
        }
        params.name = txtq.trim();
    }
    console.log('otxtq', otxtq, 'params', params);

    parse_qstr(txtq);
    //search(otxtq, params); // called by parse_qstr
}

function start_loading()
{
    $('#spinner').show();
}

function stop_loading()
{
    $('#spinner').hide();
}

function set_url(q)
{
    var url = location.protocol + '//' + location.host + location.pathname;
    url += '?q=' + q;
    history.pushState('data', '', url);
}

function do_search_by_product(boxdiv)
{
    var params = {
        brand: null,
        name: null,
        price: null
    };
    var brand = boxdiv.find('.brand').text();
    var name = boxdiv.find('.name').text();
    var price = boxdiv.find('.price').text();
    params.brand = brand || null;
    params.name = name || null;
    var newq = '' + brand + ' ' + name;
    if (price && price != 'out-of-stock') {
        newq += ' ' + price;
        params.price = Number(price.replace(/[$€£¥ ]/, ''));
    }

    window.scrollTo(0, 0);

    do_search(newq, params);

    $('#q').val(newq);
    set_url(newq);
}

function load_brand_tags()
{
    // load brands
    $.ajax({
        url: es_index() + '_search',
        type: 'POST',
        data: JSON.stringify({
            'aggs': {
                'host': {
                    'terms': {
                        'field' : 'brand_raw',
                        'size': 1000,
                    }
                }
            }
        }),
        success: function(data) {
            console.log('data', data);
            var buckets = data.aggregations.host.buckets;
            buckets.sort(function(a, b){ return b.doc_count - a.doc_count; });
            var hosts = buckets.map(function(x){ return x.key; });
            hosts.sort(function(a, b){
                a = a.toLowerCase();
                b = b.toLowerCase();
                return (a > b) - (b > a);
            });
            //console.log('hosts', hosts);
            $('brand-slugs').hide();
            hosts.forEach(function(x){
                var tag = $('<span>').append($('<a href="#">').text(x));
                $(tag).click(function(event){
                    var txtq = '' + x + '';
                    $('#q').val(txtq);
                    $('form').submit();
                    event.preventDefault();
                });
                $('#brand-slugs').append(tag);
            });
            $('brand-slugs').show();
        }
    });
}

function load_merchant_slugs()
{
    $.ajax({
        url: es_index() + '_search',
        type: 'POST',
        data: JSON.stringify({
            'aggs': {
                'host': {
                    'terms': {
                        'field' : 'merchant_slug',
                        'size': 100,
                    }
                }
            }
        }),
        success: function(data) {
            console.log('data', data);
            var buckets = data.aggregations.host.buckets;
            buckets.sort(function(a, b){ return b.doc_count - a.doc_count; });
            var hosts = buckets.map(function(x){ return x.key; });
            hosts.sort();
            console.log('hosts', hosts);
            hosts.forEach(function(x){
                $('#merchant-slugs').append($('<div>').text(x));
            });
        }
    });
}

function on_page_load()
{
    // form input

    //load_merchant_slugs()

    load_brand_tags();

    // load product count
    $.getJSON(
        es_index() + '_count',
        function(data) {
            var kcnt = (data.count / 1e6).toFixed(2);
            $('#totalproducts').text('' + kcnt + 'M products');
        }
    );

    $('form').submit(function(event) {
        start_loading();
        // event.preventDefault();
    });

    var txtq = $('#q').val();
    if (txtq) {
        console.log('txtq', txtq);
        do_search(txtq);
    }

    $('#q').droppable({
        tolerance: 'touch',
        drop: function(event, ui) {
            var dropped = ui.draggable;
            do_search_by_product(dropped);
        }
    });
}

function support_back_button()
{
    if (window.history && window.history.pushState) {
        $(window).on('popstate', function() {
            if (location.search.startsWith('?q=')) {
                var q = location.search.substr(3);
                console.log('q', q);
                $('#q').val(decodeURI(q));
                //$('#q').closest('form').submit();
            }
        });
    }
}

$(document).ready(function() {
    $('#clear').click(function() {
        $('#url').empty();
        $('#q').val('');
        $('#parse-qstr').empty();
        $('#merchant-slugs').empty();
        $('#sparkline').empty();
        $('#totalhits').empty();
        $('#results').css('height', $(window).height());
        $('#results').animate({
            height: 0
        }, 500,
            function(){
                $('#results').empty().show();
            });
        $('xmp').empty();
        set_url('');
    });
    $('a').click(function() {
        start_loading();
    });
    support_back_button();
    on_page_load();
});
    </script>
</html>
